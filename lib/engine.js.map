{
  "version": 3,
  "sources": ["../src/engine.js"],
  "sourcesContent": ["\r\nimport * as is from './is'\r\nimport same from './same'\r\nimport { kvs, resolve, decoded } from './utils'\r\n\r\nexport default class Engine {\r\n\r\n  constructor ({ virtuals = [], conditions = [], expansions = []} = {}) {\r\n    this.registry = { virtuals, conditions, expansions }\r\n  }\r\n\r\n  clone () {\r\n    return new Engine({\r\n      virtuals: this.registry.virtuals.slice(),\r\n      conditions: this.registry.conditions.slice(),\r\n      expansions: this.registry.expansions.slice()\r\n    })\r\n  }\r\n\r\n  append2 (d) {\r\n    for (let t in d) {\r\n      if (t === 'expansions' || t === 'virtuals' || t === 'conditions') {\r\n        for (let k in d[t]) {\r\n          let f = d[t][k]\r\n          this.append(t, k, f)\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  append (t, k, f) {\r\n    this.registry[t].push([ k, f ])\r\n  }\r\n\r\n  prepend (t, k, f) {\r\n    this.registry[t].shift([ k, f ])\r\n  }\r\n\r\n  replace (t, k, f) {\r\n    let [ tk ] = this.rule(k)\r\n    if (tk) {\r\n      this.registry[tk][k] = f\r\n    } else {\r\n      this.append(t, k, f)\r\n    }\r\n  }\r\n\r\n  // Find rule with k name.\r\n  rule (k) {\r\n    let r = [ undefined, undefined ]\r\n    for (let [ tk, tv ] of kvs(this.registry)) {\r\n      for (let [ rk, rf ] of tv) {\r\n        if (k === rk) {\r\n          r = [ tk, rf ]\r\n          break\r\n        }\r\n      }\r\n    }\r\n    return r\r\n  }\r\n\r\n  test (d, q = {}) {\r\n    let r = true\r\n\r\n    if (is.leaf(q)) {\r\n\r\n      // Implicit equality.\r\n      r = r && same(d, q)\r\n    } else {\r\n      for (let [ qk, qv ] of kvs(q)) {\r\n        if (qk[0] === '$') {\r\n\r\n          let [ t, f ] = this.rule(qk)\r\n          switch (t) {\r\n            case 'expansions': r = r && this.test(d, f); break\r\n            case 'virtuals': r = r && this.test(f.bind(this)(d, qv), qv); break\r\n            case 'conditions': r = r && f.bind(this)(d, qv, q); break\r\n            default: throw new Error(`Unknown rule ${qk}`)\r\n          }\r\n\r\n          if (r === false) {\r\n            break\r\n          }\r\n        } else {\r\n\r\n          // Allow \" $foo\" to reference \"$foo\" attributes.\r\n          let tqk = decoded(qk)\r\n          let [ dvp, dk ] = resolve(d, tqk) || []\r\n          if (dvp != null && dk.length === 1) {\r\n\r\n            // ...it's resolved.\r\n            r = r && this.test(dvp[dk[0]], qv)\r\n          } else {\r\n\r\n            // We can still match `{ $exists: false }`, possibly in nested\r\n            // `{ $or: [] }`.\r\n            r = r && this.test(undefined, qv)\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return r\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": ["same"]
}
